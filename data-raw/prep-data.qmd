---
title: "Prepare data"
format: html
---

```{r}
#| label: setup
#| include: false

library(tidyverse)
theme_set(theme_light())
library(countrycode)
library(glottologR)
library(WDI)
```

```{r}
#| label: bii

bii <- readRDS("raw/bii/long_data.rds") |> 
  filter(year == 2020, variable == "bii") |> 
  mutate(
    iso3c = str_extract(area_code, "[A-Z]{3}"),
    country = countrycode(iso3c, "iso3c", "country.name.en"),
    iso2c = countrycode(iso3c, "iso3c", "iso2c"),
    bii = value,
    # Adjust BII when 1 to apply qlogis later.
    bii_adj = ifelse(bii == 1, bii - 0.01, bii),
    bii_logit = qlogis(bii_adj)
  )
```

```{r}
#| label: bii-countries-mean

bii_countries_mean <- bii |> 
  summarise(
    bii_mean = mean(bii),
    bii_logit_mean = mean(bii_logit),
    bii_logit_se = sd(bii_logit) / sqrt(n()),
    .by = c(iso3c, iso2c, country)
  ) |>
  arrange(country)

write_csv(bii_countries_mean, "derived/bii-countries-mean.csv")
```

```{r}
#| label: nlangs

data("glot_aes")

nlangs_countries <- glot_aes |> 
  separate_longer_delim(Countries, ";") |> 
  mutate(
    country = countrycode(Countries, "iso2c", "country.name.en"),
    iso2c = Countries,
    iso3c = countrycode(Countries, "iso2c", "iso3c")
  ) |> 
  group_by(iso3c, iso2c, country) |> 
  count(name = "n_langs") |> 
  mutate(
    log_n_langs = log(n_langs)
  )
```

```{r}
#| label: wdi

iso2_list <- unique(codelist$iso2c)
iso2_list <- iso2_list[!is.na(iso2_list)]

country_wdi <- WDI(indicator = c("AG.SRF.TOTL.K2", "SP.POP.TOTL"), start = 2020, end = 2020, country = iso2_list)
```


```{r}
#| label: bioling

bioling <- left_join(bii_countries_mean, nlangs_countries) |> 
  left_join(y = country_wdi) |> 
  mutate(
    log_area = log(AG.SRF.TOTL.K2),
    log_pop = log(SP.POP.TOTL)
  ) |> 
  as_tibble()

write_csv(bioling, "derived/bioling.csv")

usethis::use_data(bioling, overwrite = TRUE)
```

